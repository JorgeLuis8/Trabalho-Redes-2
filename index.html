<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel de Testes HTTP ‚Äî Sequencial vs Concorrente</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --txt:#e5e7eb; --accent:#3b82f6; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Inter,Arial,sans-serif;background:var(--bg);color:var(--txt);margin:24px}
  h1{margin:0 0 8px} h2{margin:16px 0 8px}
  .row{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:16px}
  label{font-size:14px;color:var(--muted)} input,select,button{font-size:14px}
  input[type="text"],input[type="number"]{width:100%;padding:8px;border-radius:10px;border:1px solid #374151;background:#0b1220;color:#e5e7eb}
  .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;background:var(--accent);color:white}
  .btn.secondary{background:#64748b}
  .btn.warn{background:var(--warn)} .btn.ok{background:var(--ok)} .btn.err{background:var(--err)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  pre{background:#0b1220;border:1px solid #1f2937;border-radius:10px;padding:12px;overflow:auto;max-height:360px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px;border-bottom:1px solid #1f2937;text-align:left;font-size:14px}
  th{color:#cbd5e1}
  small{color:var(--muted)}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#1f2937;margin-right:6px}
</style>
</head>
<body>
  <h1>üåê Painel de Testes HTTP ‚Äî Sequencial vs Concorrente</h1>
  <small>Envia requisi√ß√µes HTTP ‚Äúpuras‚Äù via <code>fetch</code> para <b>localhost:8080</b> (Sequencial) e <b>localhost:8081</b> (Concorrente), mede lat√™ncia e exporta CSV.</small>

  <div class="row">
    <div class="card">
      <h2>Identifica√ß√£o (X-Custom-ID)</h2>
      <div class="row">
        <div>
          <label>Matr√≠cula</label>
          <input id="matricula" type="text" value="20219040840">
        </div>
        <div>
          <label>Nome</label>
          <input id="nome" type="text" value="Jorge">
        </div>
      </div>
      <div style="margin-top:8px">
        <small>SHA-1 de ‚Äúmatr√≠cula + espa√ßo + nome‚Äù √© enviado no cabe√ßalho da <b>requisi√ß√£o</b>:</small><br>
        <code id="xcid" style="word-break:break-all"></code>
      </div>
    </div>

    <div class="card">
      <h2>Configura√ß√£o dos Testes</h2>
      <div class="row">
        <div>
          <label>N¬∫ de execu√ß√µes por m√©todo</label>
          <input id="nexec" type="number" min="1" value="30">
        </div>
        <div>
          <label>Intervalo entre execu√ß√µes (ms)</label>
          <input id="delay" type="number" min="0" value="0">
        </div>
      </div>
      <div style="margin-top:8px">
        <span class="pill"><input id="mGET" type="checkbox" checked> GET</span>
        <span class="pill"><input id="mPOST" type="checkbox" checked> POST</span>
        <span class="pill"><input id="mPUT" type="checkbox" checked> PUT</span>
        <span class="pill"><input id="mDELETE" type="checkbox" checked> DELETE</span>
      </div>
      <div style="margin-top:8px">
        <span class="pill"><input id="sSEQ" type="checkbox" checked> Sequencial (8080)</span>
        <span class="pill"><input id="sCONC" type="checkbox" checked> Concorrente (8081)</span>
      </div>
      <div style="margin-top:12px" class="grid2">
        <button class="btn ok" id="runBatch">‚ñ∂Ô∏è Rodar Testes (N vezes)</button>
        <button class="btn secondary" id="dlCSV" disabled>üíæ Baixar CSV</button>
      </div>
    </div>

    <div class="card">
      <h2>Requisi√ß√£o √önica (para screenshots)</h2>
      <div class="row">
        <div>
          <label>Servidor</label>
          <select id="onceServer">
            <option value="seq">Sequencial (8080)</option>
            <option value="conc">Concorrente (8081)</option>
          </select>
        </div>
        <div>
          <label>M√©todo</label>
          <select id="onceMethod">
            <option>GET</option><option>POST</option><option>PUT</option><option>DELETE</option>
          </select>
        </div>
      </div>
      <div style="margin-top:12px">
        <button class="btn" id="sendOnce">üì® Enviar e exibir resposta</button>
      </div>
    </div>
  </div>

  <div class="row" style="margin-top:16px">
    <div class="card">
      <h2>üìú Resposta (Status + Headers + Body)</h2>
      <pre id="respBox">Aguardando‚Ä¶</pre>
    </div>
    <div class="card">
      <h2>üìä M√©tricas (por servidor √ó m√©todo)</h2>
      <table id="tbl">
        <thead><tr><th>Servidor</th><th>M√©todo</th><th>M√©dia (s)</th><th>œÉ</th><th>Min</th><th>Max</th><th>N</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>üßæ Log</h2>
    <pre id="log"></pre>
  </div>

<script>
const SERVERS = {
  seq: "http://localhost:8080",
  conc: "http://localhost:8081",
};
const respBox = document.getElementById("respBox");
const logBox  = document.getElementById("log");
const tblBody = document.querySelector("#tbl tbody");
const dlBtn   = document.getElementById("dlCSV");

function logln(s){ logBox.textContent += s + "\n"; logBox.scrollTop = logBox.scrollHeight; }

async function sha1Hex(str){
  const buf = new TextEncoder().encode(str);
  const hash = await crypto.subtle.digest("SHA-1", buf);
  const bytes = Array.from(new Uint8Array(hash));
  return bytes.map(b=>b.toString(16).padStart(2,"0")).join("");
}

function stats(arr){
  if(!arr.length) return {avg:0,std:0,min:0,max:0};
  const n=arr.length, avg=arr.reduce((a,b)=>a+b,0)/n;
  const varp=arr.reduce((a,b)=>a+(b-avg)*(b-avg),0)/n;
  return {avg,std:Math.sqrt(varp),min:Math.min(...arr),max:Math.max(...arr)};
}

function toCSV(rows){
  const head = ["Servidor","Metodo","Media","Desvio","Min","Max","N"];
  const lines = [head.join(",")].concat(rows.map(r=>r.map(x=>typeof x==="number"?x.toFixed(6):x).join(",")));
  return lines.join("\n");
}

async function fetchTimed(url, method, xcid){
  const t0 = performance.now();
  const resp = await fetch(url + "/", {
    method,
    headers: { "X-Custom-ID": xcid, "Content-Type":"text/plain" },
  });
  const text = await resp.text();
  const t1 = performance.now();
  // Monta string de headers (s√≥ os expostos pelo servidor por CORS)
  let headersStr = `HTTP/1.1 ${resp.status} ${resp.statusText}\n`;
  resp.headers.forEach((v,k)=>{ headersStr += `${k}: ${v}\n`; });
  return { ms:(t1-t0)/1000, headers:headersStr.trim(), body:text };
}

async function updateCustomId(){
  const m = document.getElementById("matricula").value.trim();
  const n = document.getElementById("nome").value.trim();
  const x = await sha1Hex(`${m} ${n}`);
  document.getElementById("xcid").textContent = x;
  return x;
}

// Requisi√ß√£o √∫nica ‚Äî para ‚Äúprints‚Äù pro relat√≥rio
document.getElementById("sendOnce").onclick = async () => {
  const xcid = await updateCustomId();
  const s = document.getElementById("onceServer").value;  // seq|conc
  const m = document.getElementById("onceMethod").value;  // GET|POST|PUT|DELETE
  const url = SERVERS[s];
  try{
    const r = await fetchTimed(url, m, xcid);
    respBox.textContent = r.headers + "\n----- BODY -----\n" + r.body;
  }catch(e){
    respBox.textContent = "Erro: " + e;
  }
};

// Teste em lote ‚Äî N execu√ß√µes por m√©todo/servidor
document.getElementById("runBatch").onclick = async () => {
  const xcid = await updateCustomId();
  const N = parseInt(document.getElementById("nexec").value,10) || 10;
  const delay = parseInt(document.getElementById("delay").value,10) || 0;
  const methods = ["GET","POST","PUT","DELETE"].filter(m=>document.getElementById("m"+m).checked);
  const servers = [];
  if(document.getElementById("sSEQ").checked) servers.push({name:"Sequencial", key:"seq"});
  if(document.getElementById("sCONC").checked) servers.push({name:"Concorrente", key:"conc"});

  tblBody.innerHTML = ""; logBox.textContent = "";
  const results = []; // para CSV

  for(const srv of servers){
    for(const met of methods){
      const times=[];
      logln(`=== ${srv.name} / ${met} ‚Äî executando ${N}x ===`);
      for(let i=0;i<N;i++){
        try{
          const r = await fetchTimed(SERVERS[srv.key], met, xcid);
          times.push(r.ms);
          logln(`[${srv.name}] ${met} ${i+1}/${N} -> ${r.ms.toFixed(5)}s`);
          if(delay>0) await new Promise(res=>setTimeout(res, delay));
          if(i===0) respBox.textContent = r.headers + "\n----- BODY -----\n" + r.body; // primeira amostra
        }catch(e){
          logln(`‚ö†Ô∏è Erro (${met} #${i+1}): ${e}`);
        }
      }
      const st = stats(times);
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${srv.name}</td><td>${met}</td>
        <td>${st.avg.toFixed(6)}</td><td>${st.std.toFixed(6)}</td>
        <td>${st.min.toFixed(6)}</td><td>${st.max.toFixed(6)}</td><td>${times.length}</td>`;
      tblBody.appendChild(tr);
      results.push([srv.name, met, st.avg, st.std, st.min, st.max, times.length]);
    }
  }

  // habilita download CSV
  dlBtn.disabled = false;
  dlBtn.onclick = () => {
    const blob = new Blob([toCSV(results)], {type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "resultados_frontend.csv";
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  };
};

// atualiza X-Custom-ID ao abrir
updateCustomId();
</script>
</body>
</html>
